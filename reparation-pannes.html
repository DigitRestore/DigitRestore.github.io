<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DigitRestore ‚Äì Types de r√©paration</title>

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Montserrat:wght@800&display=swap" rel="stylesheet">

    <style>
        :root {
            --accent-1: #ff4b5c;
            --accent-2: #ff2c47;
            --accent-3: #4fd2ff;
            --text-main: #f5f5f7;
            --text-soft: #c3c8df;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            min-height: 100vh;
            width: 100%;
            overflow-x: hidden;
            font-family: "Poppins", sans-serif;
            color: var(--text-main);

            background:
                radial-gradient(circle at 20% 10%, rgba(255,75,92,0.18), transparent 60%),
                radial-gradient(circle at 80% 90%, rgba(79,210,255,0.16), transparent 60%),
                #050814;
            background-size: cover;
            animation: bgMove 30s ease-in-out infinite alternate;
        }

        @keyframes bgMove {
            0%   { background-position: 0% 0%; }
            100% { background-position: 12% 16%; }
        }

        /* HEADER --------------------------------------------------- */

        header {
            width: 100%;
            padding: 20px 40px;
            display: flex;
            align-items: center;
            gap: 26px;
            opacity: 0;
            animation: fadeDown 0.9s ease forwards;
        }

        @keyframes fadeDown {
            from { opacity: 0; transform: translateY(-18px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        .back-btn {
            width: 46px;
            height: 46px;
            border-radius: 50%;
            background: rgba(255,75,92,0.22);
            border: 1px solid rgba(255,75,92,0.45);
            display: flex;
            justify-content: center;
            align-items: center;
            text-decoration: none;
            transition: .25s;
            box-shadow: 0 0 14px rgba(255,75,92,0.35);
        }

        .back-btn span {
            font-size: 22px;
            color: white;
        }

        .back-btn:hover {
            transform: scale(1.12);
            box-shadow: 
                0 0 24px rgba(255,75,92,0.55),
                0 0 18px rgba(79,210,255,0.55);
            border-color: rgba(79,210,255,0.65);
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .brand img { width: 68px; height: 68px; }

        .brand-text { display: flex; flex-direction: column; line-height: 1.18; }

        .digit {
            font-family: "Montserrat";
            font-size: 22px;
            font-weight: 800;
        }

        .restore {
            font-size: 22px;
            font-family: "Montserrat";
            font-weight: 900;
            background: linear-gradient(120deg, var(--accent-1), var(--accent-2));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .tag {
            font-size: 10px;
            letter-spacing: .22em;
            color: var(--accent-3);
        }

        nav {
            margin-left: auto;
            display: flex;
            gap: 32px;
        }

        nav a {
            text-decoration: none;
            color: var(--text-main);
            font-size: 14px;
            opacity: .85;
            transition: .25s;
        }

        nav a:hover {
            opacity: 1;
            color: var(--accent-3);
        }

        /* CONTENT --------------------------------------------------- */

        .content {
            padding: 20px 40px 40px;
            max-width: 1400px;
            margin: 0 auto;
            animation: fadeUp 1s ease forwards;
            opacity: 0;
        }

        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(30px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        .page-title {
            font-size: 34px;
            font-weight: 600;
            margin-bottom: 20px;
            text-shadow: 0 0 10px rgba(79,210,255,0.28);
        }

        .hint {
            font-size: 14px;
            color: var(--text-soft);
            margin-bottom: 20px;
        }

        /* GRID --------------------------------------------------- */

        .faults-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 22px;
        }

        .fault-card {
            background: rgba(5,8,20,0.96);
            border-radius: 14px;
            padding: 16px 6px;
            border: 1px solid rgba(255,255,255,0.06);
            width: 85%;
            margin: 0 auto;
            box-shadow: 0 14px 28px rgba(0,0,0,0.6);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            text-decoration: none;
            color: inherit;
            transition: .3s ease;
        }

        .fault-card:hover {
            transform: translateY(-8px);
            border-color: rgba(255,75,92,0.9);
            box-shadow:
                0 0 26px rgba(255,75,92,0.55),
                0 0 18px rgba(79,210,255,0.55),
                0 20px 40px rgba(0,0,0,0.9);
        }

        .fault-icon { font-size: 28px; }
        .fault-title { font-size: 15px; font-weight: 600; text-align: center; }

        @media (max-width: 968px) {
            .faults-grid { grid-template-columns: repeat(3, 1fr); }
        }

        @media (max-width: 768px) {
            nav { display: none; }
            .faults-grid { grid-template-columns: repeat(2, 1fr); }
        }

        /* PANEL COULISSANT --------------------------------------------------- */

        .price-panel {
            position: fixed;
            left: 0;
            bottom: -350px;
            width: 100%;
            background: rgba(5, 8, 20, 0.96);
            box-shadow: 0 -8px 30px rgba(0,0,0,0.5);
            border-top: 1px solid rgba(79,210,255,0.3);
            padding: 25px;
            transition: bottom 0.45s ease;
            z-index: 9999;
        }

        .price-panel.show {
            bottom: 0;
        }

        .panel-title {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 10px;
            text-align: center;
        }

        .panel-price {
            font-size: 32px;
            font-weight: 700;
            text-align: center;
            color: var(--accent-3);
            margin-bottom: 22px;
        }

        .close-panel {
            display: block;
            margin: 0 auto;
            padding: 12px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            background: linear-gradient(135deg, var(--accent-1), var(--accent-3));
            color: white;
            font-size: 16px;
            font-weight: 600;
            transition: 0.25s;
        }

        .close-panel:hover {
            transform: scale(1.08);
        }
    </style>
</head>

<body>

<header>
    <a href="reparation.html" class="back-btn"><span>‚üµ</span></a>

    <div class="brand">
        <img src="logo.png" alt="Logo DigitRestore">
        <div class="brand-text">
            <span class="digit">DIGIT <span class="restore">RESTORE</span></span>
            <span class="tag">R√âPARATION & RECONDITIONNEMENT</span>
            <span class="tag">SMARTPHONES & TABLETTES</span>
        </div>
    </div>

    <nav>
        <a href="site.html">Atelier</a>
        <a href="reparation.html">R√©paration</a>
        <a href="#">Reprise / Achat</a>
        <a href="#">Reconditionnement</a>
        <a href="#">T√©l√©phones & Accessoires</a>
        <a href="#">Qualit√©</a>
        <a href="#">Conditions g√©n√©rales</a>
        <a href="#">Contact</a>
    </nav>
</header>

<div class="content">

    <div class="page-title">Choisissez le type de r√©paration</div>
    <p class="hint">Cliquez sur une panne pour continuer.</p>

    <div class="faults-grid" id="faultsGrid"></div>

</div>

<!-- PANEL PRICE -->
<div id="pricePanel" class="price-panel">
    <div class="panel-content">
        <div id="panelRepairName" class="panel-title"></div>
        <div id="panelPrice" class="panel-price"></div>
        <button id="closePanelBtn" class="close-panel">Fermer</button>
    </div>
</div>


<!-- SCRIPT -->
<script>
document.addEventListener("DOMContentLoaded", async () => {

    const faultsGrid = document.getElementById("faultsGrid");

    /* 1 ‚Äî R√©cup√©rer type/marque/mod√®le depuis l'URL */
    const params = new URLSearchParams(window.location.search);
    const type   = params.get("type");   // ex: "smartphones", "tablettes"
    const marque = params.get("marque"); // ex: "Apple"
    const modele = params.get("modele"); // ex: "iPhone 12"

    if (!type || !marque || !modele) {
        console.error("Param√®tres manquants dans l'URL.");
        return;
    }

    /* Utilitaire : normaliser une marque pour le nom de fichier (Apple ‚Üí apple) */
    function slugifyBrand(brand) {
        return brand
            .toLowerCase()
            .trim()
            .replace(/\s+/g, "-")
            .replace(/[^a-z0-9\-]/g, "");
    }

    const brandSlug = slugifyBrand(marque);
    const jsonPath  = `donnees/${type}-${brandSlug}.json`;

    /* 2 ‚Äî Charger le JSON correspondant au type + marque */
    let data = {};
    try {
        const response = await fetch(jsonPath, { cache: "no-cache" });
        if (!response.ok) {
            throw new Error("HTTP " + response.status);
        }
        data = await response.json();
    } catch (e) {
        console.error("Erreur lors du chargement du JSON de r√©parations :", e);
        return;
    }

    /* 3 ‚Äî R√©cup√©ration des r√©parations pour ce mod√®le */
    let repairs = [];

    // Cas privil√©gi√© : nouveau format { models: { "iPhone 12": ["facade_avant", ...] } }
    if (data.models && typeof data.models === "object") {
        repairs = data.models[modele] || [];
    }
    // Cas de secours : ancien format √©ventuel { repairs: { "iPhone 12": [...] } }
    else if (data.repairs && typeof data.repairs === "object") {
        repairs = data.repairs[modele] || [];
    }

    if (!Array.isArray(repairs)) {
        repairs = [];
    }

    /* 4 ‚Äî Table de correspondance des r√©parations */
const REPAIR_MAP = {
    "facade_avant":         { label: "Fa√ßade avant",          icon: "üì±" },
    "facade_arriere":       { label: "Fa√ßade arri√®re",        icon: "üìò" },
    "batterie":             { label: "Batterie",              icon: "üîã" },
    "connecteur_de_charge": { label: "Connecteur de charge",  icon: "üîå" },
    "camera_avant":         { label: "Cam√©ra avant",          icon: "üì∑" },
    "camera_arriere":       { label: "Cam√©ra arri√®re",        icon: "üé•" },
    "micro":                { label: "Micro",                 icon: "üé§" },
    "haut_parleur":         { label: "Haut-parleur",          icon: "üîà" },
    "power":                { label: "Bouton power",          icon: "‚èª" },
    "volume":               { label: "Boutons volume",        icon: "üîâ" }
};


    /* 5 ‚Äî G√©n√©ration des cartes */
    if (repairs.length === 0) {
        const infoDiv = document.createElement("div");
        infoDiv.textContent = "Aucune r√©paration n'est d√©finie pour ce mod√®le pour le moment.";
        infoDiv.style.gridColumn = "1 / -1";
        infoDiv.style.textAlign = "center";
        faultsGrid.appendChild(infoDiv);
    } else {
        repairs.forEach(repairId => {

            const info = REPAIR_MAP[repairId] || {
                label: repairId,
                icon: "üîß"
            };

            const card = document.createElement("a");
            card.href = "#";
            card.className = "fault-card";

            card.innerHTML = `
                <div class="fault-icon">${info.icon}</div>
                <div class="fault-title">${info.label}</div>
            `;

            card.addEventListener("click", async (e) => {
                e.preventDefault();
                await getPriceFromAPI(repairId, info.label);
            });

            faultsGrid.appendChild(card);
        });
    }


    /* 6 ‚Äî APPEL API CLOUDFLARE */
    async function getPriceFromAPI(repairId, label) {

        const url = "https://royal-wind-ec1e.kinny.workers.dev";  // ton Worker üî•

        try {
            const response = await fetch(url, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    type,
                    marque,
                    modele,
                    reparation: repairId
                })
            });

            if (!response.ok) {
                throw new Error("Erreur API : " + response.status);
            }

            const result = await response.json();

            openPanel(label, result.prix_final);

        } catch (err) {
            console.error("Erreur Worker :", err);
            openPanel(label, "Erreur API");
        }
    }


    /* 7 ‚Äî PANEL COULISSANT */
    const pricePanel = document.getElementById("pricePanel");
    const panelTitle = document.getElementById("panelRepairName");
    const panelPrice = document.getElementById("panelPrice");
    const closeBtn   = document.getElementById("closePanelBtn");

    function openPanel(label, price) {
        panelTitle.textContent = label;
        panelPrice.textContent = (price === "Erreur API")
            ? "Erreur lors du calcul"
            : price + " ‚Ç¨";

        pricePanel.classList.add("show");
    }

    closeBtn.addEventListener("click", () => {
        pricePanel.classList.remove("show");
    });

});
</script>

</body>
</html>
